// app_m.js - MRA v3 Mobile Frontend Logic
console.log('=== app_m.js loaded successfully ===');

// State Management
const state = {
    currentSessionId: null,
    messages: [],
    context: [],
    uploadedDocuments: [],  // Store uploaded document content
    settings: {
        model: 'ministral-3:14b',
        temperature: 0.7,
        topP: 0.9,
        topKGen: 40,
        maxTokens: 8000,
        contextWindow: 128000,
        topK: 20,
        searchScope: {
            referencePapers: false,
            myPapers: false,
            sessions: false,
            webCache: false
        },
        useWebSearch: false,
        useDistortion: false,
        useEnsemble: false,
        includeConversationContext: true,
        distortion: {
            mode: 'cucumb_er',
            tone: 'neutral',
            gain: 5
        }
    }
};

// Current exchange container (for collapsible chat)
let currentExchange = null;

// API Base URL
const API_BASE = window.location.origin;

// Configure marked.js for markdown parsing
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== MRA Mobile initializing ===');
    console.log('API_BASE:', API_BASE);
    
    initializeEventListeners();
    
    // Check service status immediately and log results
    checkServiceStatus().then(() => {
        console.log('Initial service status check complete');
    }).catch(err => {
        console.error('Initial service status check failed:', err);
    });
    
    // Setup welcome exchange toggle
    const welcomeHeader = document.querySelector('#welcome-exchange .exchange-header');
    if (welcomeHeader) {
        welcomeHeader.addEventListener('click', () => toggleExchange('welcome-exchange'));
    }
    
    // Log key DOM elements
    console.log('chat-messages element:', document.getElementById('chat-messages'));
    console.log('query-input element:', document.getElementById('query-input'));
    console.log('send-query-btn element:', document.getElementById('send-query-btn'));
});

// Event Listeners
function initializeEventListeners() {
    // Query box
    const sendQueryBtn = document.getElementById('send-query-btn');
    const queryInput = document.getElementById('query-input');
    const clearQueryBtn = document.getElementById('clear-query-btn');
    
    sendQueryBtn.addEventListener('click', () => {
        const query = queryInput.value.trim();
        if (query) {
            sendMessage(query);
        }
    });
    
    queryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            sendQueryBtn.click();
        }
    });
    
    clearQueryBtn.addEventListener('click', () => {
        queryInput.value = '';
        queryInput.focus();
    });
    
    // Settings - Model
    document.getElementById('model-select').addEventListener('change', (e) => {
        state.settings.model = e.target.value;
    });
    
    // Settings - Sliders
    document.getElementById('temperature').addEventListener('input', (e) => {
        state.settings.temperature = parseFloat(e.target.value);
        document.getElementById('temp-value').textContent = e.target.value;
    });
    
    document.getElementById('top-p').addEventListener('input', (e) => {
        state.settings.topP = parseFloat(e.target.value);
        document.getElementById('top-p-value').textContent = e.target.value;
    });
    
    document.getElementById('top-k-gen').addEventListener('input', (e) => {
        state.settings.topKGen = parseInt(e.target.value);
        document.getElementById('top-k-gen-value').textContent = e.target.value;
    });
    
    document.getElementById('max-tokens').addEventListener('input', (e) => {
        state.settings.maxTokens = parseInt(e.target.value);
        document.getElementById('max-tokens-value').textContent = e.target.value;
    });
    
    document.getElementById('context-window').addEventListener('input', (e) => {
        state.settings.contextWindow = parseInt(e.target.value);
        document.getElementById('context-window-value').textContent = e.target.value;
    });
    
    document.getElementById('top-k').addEventListener('input', (e) => {
        state.settings.topK = parseInt(e.target.value);
        document.getElementById('top-k-value').textContent = e.target.value;
    });
    
    document.getElementById('distortion-gain').addEventListener('input', (e) => {
        state.settings.distortion.gain = parseInt(e.target.value);
        document.getElementById('gain-value').textContent = e.target.value;
    });
    
    // Settings - Checkboxes
    document.getElementById('scope-reference').addEventListener('change', (e) => {
        state.settings.searchScope.referencePapers = e.target.checked;
    });
    
    document.getElementById('scope-authored').addEventListener('change', (e) => {
        state.settings.searchScope.myPapers = e.target.checked;
    });
    
    document.getElementById('scope-sessions').addEventListener('change', (e) => {
        state.settings.searchScope.sessions = e.target.checked;
    });
    
    document.getElementById('scope-web-cache').addEventListener('change', (e) => {
        state.settings.searchScope.webCache = e.target.checked;
    });
    
    // Web Search Toggle
    document.getElementById('enable-web-search').addEventListener('change', (e) => {
        state.settings.useWebSearch = e.target.checked;
    });
    
    // Distortion Toggle
    document.getElementById('enable-distortion').addEventListener('change', (e) => {
        state.settings.useDistortion = e.target.checked;
        const controls = document.getElementById('distortion-controls');
        controls.classList.toggle('active', e.target.checked);
    });
    
    document.getElementById('ensemble-mode').addEventListener('change', (e) => {
        state.settings.useEnsemble = e.target.checked;
    });
    
    document.getElementById('conversation-context').addEventListener('change', (e) => {
        state.settings.includeConversationContext = e.target.checked;
    });
    
    document.getElementById('distortion-mode').addEventListener('change', (e) => {
        state.settings.distortion.mode = e.target.value;
    });
    
    document.getElementById('distortion-tone').addEventListener('change', (e) => {
        state.settings.distortion.tone = e.target.value;
    });
    
    // File Upload
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-upload-input');
    
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);
    
    // News Articles Browser
    const browseNewsBtn = document.getElementById('browse-news-btn');
    browseNewsBtn.addEventListener('click', openNewsModal);
    
    // News Modal
    const newsModalClose = document.getElementById('news-modal-close');
    newsModalClose.addEventListener('click', closeNewsModal);
    
    const newsModal = document.getElementById('news-modal');
    newsModal.addEventListener('click', (e) => {
        if (e.target === newsModal) closeNewsModal();
    });
    
    const newsSearchInput = document.getElementById('news-search-input');
    newsSearchInput.addEventListener('input', filterNewsArticles);
}

// Check service status
async function checkServiceStatus() {
    console.log('Checking service status...');
    try {
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        console.log('Health check response:', data);
        
        // Update status dots
        const ollamaStatus = document.getElementById('ollama-status');
        const twistedStatus = document.getElementById('twisted-status');
        
        if (!ollamaStatus || !twistedStatus) {
            console.error('Status indicators not found in DOM!');
            return;
        }
        
        console.log('Ollama status:', data.services?.ollama?.status);
        console.log('TwistedPair status:', data.services?.twistedpair?.status);
        
        // Ollama status
        if (data.services?.ollama?.status === 'online') {
            console.log('Setting Ollama to online');
            ollamaStatus.classList.remove('offline');
            ollamaStatus.classList.add('online');
        } else {
            console.log('Setting Ollama to offline');
            ollamaStatus.classList.remove('online');
            ollamaStatus.classList.add('offline');
        }
        
        // TwistedPair status
        if (data.services?.twistedpair?.status === 'online') {
            console.log('Setting TwistedPair to online');
            twistedStatus.classList.remove('offline');
            twistedStatus.classList.add('online');
        } else {
            console.log('Setting TwistedPair to offline');
            twistedStatus.classList.remove('online');
            twistedStatus.classList.add('offline');
        }
        
        // Populate model dropdown
        if (data.services?.ollama?.status === 'online' && data.services?.ollama?.models) {
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '';
            
            data.services.ollama.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === state.settings.model) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            
            modelSelect.disabled = false;
        }
        
        // Update document counts
        if (data.indices) {
            const countElements = {
                reference_papers: document.getElementById('count-reference'),
                my_papers: document.getElementById('count-authored'),
                sessions: document.getElementById('count-sessions'),
                web_cache: document.getElementById('count-web')
            };
            
            Object.keys(countElements).forEach(key => {
                if (countElements[key] && data.indices[key]) {
                    const count = data.indices[key].docs || 0;
                    countElements[key].textContent = count.toLocaleString();
                }
            });
        }
    } catch (error) {
        console.error('Health check failed:', error);
        document.querySelectorAll('.status-dot').forEach(dot => dot.classList.add('offline'));
        document.getElementById('model-select').disabled = true;
    }
    
    setTimeout(checkServiceStatus, 60000);
}

// Handle file upload
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const statusDiv = document.getElementById('upload-status');
    const fileInput = document.getElementById('file-upload-input');
    
    const validExtensions = ['.pdf', '.txt', '.csv', '.md', '.markdown'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!validExtensions.includes(fileExtension)) {
        statusDiv.innerHTML = '<span style="color: var(--danger);">‚ùå Unsupported file type</span>';
        statusDiv.classList.add('visible', 'error');
        fileInput.value = '';
        return;
    }
    
    statusDiv.innerHTML = `<span>‚è≥ Uploading ${file.name}...</span>`;
    statusDiv.classList.add('visible');
    statusDiv.classList.remove('success', 'error');
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${API_BASE}/api/upload`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Upload failed');
        }
        
        const data = await response.json();
        
        statusDiv.innerHTML = `<span>‚úÖ ${data.filename}</span>`;
        statusDiv.classList.add('success');
        
        state.uploadedDocuments.push({
            filename: data.filename,
            content: data.markdown_content,
            token_count: data.token_count,
            uploaded_at: new Date().toISOString()
        });
        
        addUploadedDocToChat(data);
        
        setTimeout(() => {
            statusDiv.innerHTML = '';
            statusDiv.classList.remove('visible', 'success', 'error');
            fileInput.value = '';
        }, 3000);
        
    } catch (error) {
        console.error('Upload error:', error);
        statusDiv.innerHTML = `<span>‚ùå ${error.message}</span>`;
        statusDiv.classList.add('error');
        fileInput.value = '';
    }
}

// Add uploaded document to chat
function addUploadedDocToChat(uploadData) {
    const chatMessages = document.getElementById('chat-messages');
    
    const exchangeId = `exchange-upload-${Date.now()}`;
    const exchangeDiv = document.createElement('div');
    exchangeDiv.className = 'exchange-container';
    exchangeDiv.id = exchangeId;
    
    exchangeDiv.innerHTML = `
        <div class="exchange-header">
            <span class="exchange-summary">üìÑ ${uploadData.filename}</span>
            <span class="exchange-toggle">‚ñº</span>
        </div>
        <div class="exchange-content">
            <div class="message system">
                <div class="message-avatar">üì§</div>
                <div class="message-content">
                    <p><strong>Document uploaded:</strong></p>
                    <ul>
                        <li><strong>File:</strong> ${uploadData.filename}</li>
                        <li><strong>Type:</strong> ${uploadData.file_type}</li>
                        <li><strong>Tokens:</strong> ${uploadData.token_count.toLocaleString()}</li>
                    </ul>
                    <p><em>You can now ask questions about this document!</em></p>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(exchangeDiv);
    
    const header = exchangeDiv.querySelector('.exchange-header');
    header.addEventListener('click', () => toggleExchange(exchangeId));
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
async function sendMessage(queryText = null) {
    const textarea = document.getElementById('query-input');
    const message = queryText || textarea.value.trim();
    
    console.log('sendMessage called with:', message);
    
    if (!message) return;
    
    if (!queryText) {
        textarea.value = '';
    }
    
    const sendBtn = document.getElementById('send-query-btn');
    sendBtn.disabled = true;
    
    console.log('Starting new exchange...');
    collapseAllExchanges();
    startNewExchange();
    addMessage('user', message);
    
    const streamingId = addStreamingMessage();
    console.log('Created streaming message:', streamingId);
    
    try {
        const requestData = {
            session_id: state.currentSessionId || 'new',
            message: message,
            use_rag: true,
            use_web_search: state.settings.useWebSearch,
            use_distortion: state.settings.useDistortion,
            use_ensemble_distortion: state.settings.useEnsemble,
            include_conversation_context: state.settings.includeConversationContext,
            search_scope: {
                reference_papers: state.settings.searchScope.referencePapers,
                my_papers: state.settings.searchScope.myPapers,
                sessions: state.settings.searchScope.sessions,
                web_cache: state.settings.searchScope.webCache
            },
            model: state.settings.model,
            temperature: state.settings.temperature,
            top_p: state.settings.topP,
            top_k: state.settings.topKGen,
            max_tokens: state.settings.maxTokens,
            num_ctx: state.settings.contextWindow,
            top_k_retrieval: state.settings.topK,
            distortion_mode: state.settings.distortion.mode,
            distortion_tone: state.settings.distortion.tone,
            distortion_gain: state.settings.distortion.gain
        };
        
        if (state.uploadedDocuments.length > 0) {
            requestData.uploaded_context = state.uploadedDocuments.map(doc => ({
                filename: doc.filename,
                content: doc.content
            }));
        }
        
        const response = await fetch(`${API_BASE}/api/chat/message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log('Response received:', response.status, response.statusText);
        console.log('Response headers:', response.headers);
        console.log('Response body:', response.body);
        
        if (!response.body) {
            throw new Error('Response body is null - not a streaming response');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let contextData = null;
        let tokenCount = 0;
        
        console.log('Starting to read stream...');
        console.log('Reader:', reader);
        
        try {
            while (true) {
                console.log('About to call reader.read()...');
                const { done, value } = await reader.read();
                console.log('Read result - done:', done, 'value:', value);
                
                if (done) {
                    console.log('Stream complete. Total tokens:', tokenCount);
                    break;
                }
            
            const chunk = decoder.decode(value, { stream: true });
            console.log('Received chunk (length):', chunk.length);
            const lines = chunk.split('\n');
            console.log('Number of lines in chunk:', lines.length);
            
            for (const line of lines) {
                if (!line.trim() || !line.startsWith('data: ')) continue;
                
                const jsonStr = line.substring(6);
                if (jsonStr === '[DONE]') {
                    console.log('Received [DONE] signal');
                    continue;
                }
                
                try {
                    const data = JSON.parse(jsonStr);
                    console.log('Parsed data type:', data.type, data);
                    
                    if (data.type === 'session_id') {
                        state.currentSessionId = data.session_id;
                        console.log('Session ID:', data.session_id);
                    } else if (data.type === 'context') {
                        contextData = data.context;
                        console.log('Context received:', contextData.length, 'items');
                    } else if (data.type === 'token') {
                        tokenCount++;
                        appendToStreamingMessage(streamingId, data.token);
                    } else if (data.type === 'distorted_query') {
                        console.log('Distorted query:', data.query);
                    } else if (data.type === 'done') {
                        console.log('Finalizing message...');
                        finalizeStreamingMessage(streamingId, contextData);
                    } else if (data.type === 'error') {
                        console.error('Stream error:', data.error);
                        throw new Error(data.error);
                    }
                } catch (parseError) {
                    console.error('JSON parse error:', parseError, 'Line:', jsonStr);
                }
            }
        }
        } catch (streamError) {
            console.error('Stream reading error:', streamError);
            throw streamError;
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        const messageDiv = document.getElementById(streamingId);
        if (messageDiv) {
            const contentDiv = messageDiv.querySelector('.message-content');
            contentDiv.textContent = `‚ùå Error: ${error.message}`;
            const cursor = contentDiv.querySelector('.streaming-cursor');
            if (cursor) cursor.remove();
        }
    } finally {
        sendBtn.disabled = false;
    }
}

// Start new exchange
function startNewExchange() {
    const messagesContainer = document.getElementById('chat-messages');
    const exchangeId = `exchange-${Date.now()}`;
    
    const exchangeDiv = document.createElement('div');
    exchangeDiv.className = 'exchange-container';
    exchangeDiv.id = exchangeId;
    
    exchangeDiv.innerHTML = `
        <div class="exchange-header">
            <span class="exchange-summary">üí¨ New Query</span>
            <span class="exchange-toggle">‚ñº</span>
        </div>
        <div class="exchange-content">
        </div>
    `;
    
    messagesContainer.appendChild(exchangeDiv);
    currentExchange = exchangeDiv;
    
    const header = exchangeDiv.querySelector('.exchange-header');
    header.addEventListener('click', () => toggleExchange(exchangeId));
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Update exchange header
function updateExchangeHeader(userMessage) {
    if (!currentExchange) return;
    
    const header = currentExchange.querySelector('.exchange-summary');
    const preview = userMessage.length > 50 ? userMessage.substring(0, 50) + '...' : userMessage;
    header.textContent = `üí¨ ${preview}`;
}

// Toggle exchange
function toggleExchange(exchangeId) {
    const exchange = document.getElementById(exchangeId);
    if (!exchange) return;
    
    const content = exchange.querySelector('.exchange-content');
    const toggle = exchange.querySelector('.exchange-toggle');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.textContent = '‚ñº';
    } else {
        content.classList.add('collapsed');
        toggle.textContent = '‚ñ∂';
    }
}

// Collapse all exchanges
function collapseAllExchanges() {
    document.querySelectorAll('.exchange-content').forEach(content => {
        if (!content.classList.contains('collapsed')) {
            content.classList.add('collapsed');
            const toggle = content.parentElement.querySelector('.exchange-toggle');
            if (toggle) toggle.textContent = '‚ñ∂';
        }
    });
}

// Add message
function addMessage(role, content, isHtml = false, sources = null) {
    const messagesContainer = document.getElementById('chat-messages');
    const targetContainer = currentExchange ? currentExchange.querySelector('.exchange-content') : messagesContainer;
    const messageId = `msg-${Date.now()}`;
    
    if (role === 'user' && !isHtml && currentExchange) {
        updateExchangeHeader(content);
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.id = messageId;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isHtml) {
        contentDiv.innerHTML = content;
    } else {
        if (role === 'assistant') {
            messageDiv.setAttribute('data-markdown', content);
        }
        
        if (role === 'assistant' && typeof marked !== 'undefined') {
            contentDiv.innerHTML = marked.parse(content);
        } else {
            contentDiv.textContent = content;
        }
    }
    
    if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'message-sources';
        sourcesDiv.innerHTML = '<strong>Sources:</strong><br>';
        
        sources.forEach((source, i) => {
            const scoreText = (typeof source.score === 'number') ? source.score.toFixed(2) : 'N/A';
            const label = source.title || source.source || `Source ${i+1}`;
            const tag = document.createElement('span');
            tag.className = 'source-tag';
            tag.textContent = `${label} (${scoreText})`;
            sourcesDiv.appendChild(tag);
        });
        
        contentDiv.appendChild(sourcesDiv);
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    targetContainer.appendChild(messageDiv);
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

// Add streaming message
function addStreamingMessage() {
    const messagesContainer = document.getElementById('chat-messages');
    const targetContainer = currentExchange ? currentExchange.querySelector('.exchange-content') : messagesContainer;
    const messageId = `msg-${Date.now()}`;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant';
    messageDiv.id = messageId;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = 'ü§ñ';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content streaming';
    
    const cursor = document.createElement('span');
    cursor.className = 'streaming-cursor';
    cursor.textContent = '‚ñã';
    contentDiv.appendChild(cursor);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    targetContainer.appendChild(messageDiv);
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

// Append token to streaming message
function appendToStreamingMessage(messageId, token) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const contentDiv = messageDiv.querySelector('.message-content');
    if (!contentDiv) return;
    
    const cursor = contentDiv.querySelector('.streaming-cursor');
    
    if (cursor) {
        const textNode = document.createTextNode(token);
        cursor.parentNode.insertBefore(textNode, cursor);
    } else {
        contentDiv.appendChild(document.createTextNode(token));
    }
    
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Finalize streaming message
function finalizeStreamingMessage(messageId, contextData = null) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const contentDiv = messageDiv.querySelector('.message-content');
    
    const cursor = contentDiv.querySelector('.streaming-cursor');
    if (cursor) cursor.remove();
    
    contentDiv.classList.remove('streaming');
    
    const text = contentDiv.textContent.trim();
    
    if (!text || text.length === 0) {
        contentDiv.textContent = '‚ö†Ô∏è No response received from LLM.';
        return;
    }
    
    messageDiv.setAttribute('data-markdown', text);
    
    if (typeof marked !== 'undefined') {
        contentDiv.innerHTML = marked.parse(text);
    }
    
    if (contextData && contextData.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'message-sources';
        sourcesDiv.innerHTML = '<strong>Sources:</strong><br>';
        
        contextData.forEach((source, i) => {
            const scoreText = (typeof source.score === 'number') ? source.score.toFixed(2) : 'N/A';
            const label = source.title || source.source || `Source ${i+1}`;
            const tag = document.createElement('span');
            tag.className = 'source-tag';
            tag.textContent = `${label} (${scoreText})`;
            sourcesDiv.appendChild(tag);
        });
        
        contentDiv.appendChild(sourcesDiv);
    }
}

// News Modal Functions
async function openNewsModal() {
    const modal = document.getElementById('news-modal');
    const loading = document.getElementById('news-loading');
    const articlesList = document.getElementById('news-articles-list');
    const countDisplay = document.getElementById('news-count-display');
    
    modal.style.display = 'flex';
    loading.style.display = 'block';
    articlesList.innerHTML = '';
    
    try {
        const response = await fetch(`${API_BASE}/api/news-articles/list`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        loading.style.display = 'none';
        
        console.log('News articles data:', data);
        
        // API returns 'files' not 'articles'
        const articles = data.files || data.articles || [];
        
        if (articles && articles.length > 0) {
            countDisplay.textContent = `${articles.length} articles`;
            
            articles.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'news-article-item';
                // API returns 'name' field, not 'title'
                const displayTitle = article.title || article.name || article.filename;
                const displayDate = article.date || article.modified || 'No date';
                articleDiv.innerHTML = `
                    <div class="news-article-title">${displayTitle}</div>
                    <div class="news-article-meta">${displayDate}</div>
                `;
                
                articleDiv.addEventListener('click', () => loadNewsArticle(article.filename || article.name));
                articlesList.appendChild(articleDiv);
            });
        } else {
            articlesList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No articles found</p>';
            countDisplay.textContent = '0 articles';
        }
    } catch (error) {
        console.error('Error loading news articles:', error);
        loading.style.display = 'none';
        articlesList.innerHTML = `<p style="text-align: center; color: var(--danger);">Error: ${error.message}</p>`;
        countDisplay.textContent = 'Error';
    }
}

function closeNewsModal() {
    document.getElementById('news-modal').style.display = 'none';
}

async function loadNewsArticle(filename) {
    try {
        const response = await fetch(`${API_BASE}/api/news-articles/read/${filename}`);
        const data = await response.json();
        
        state.uploadedDocuments.push({
            filename: filename,
            content: data.content,
            token_count: data.token_count || 0,
            uploaded_at: new Date().toISOString()
        });
        
        const uploadData = {
            filename: filename,
            file_type: 'markdown',
            token_count: data.token_count || 0
        };
        
        addUploadedDocToChat(uploadData);
        closeNewsModal();
        
        const statusDiv = document.getElementById('news-articles-status');
        statusDiv.innerHTML = `<span>‚úÖ Loaded: ${filename}</span>`;
        statusDiv.classList.add('visible', 'success');
        
        setTimeout(() => {
            statusDiv.innerHTML = '';
            statusDiv.classList.remove('visible', 'success');
        }, 3000);
        
    } catch (error) {
        console.error('Error loading article:', error);
        alert('Failed to load article');
    }
}

function filterNewsArticles() {
    const searchTerm = document.getElementById('news-search-input').value.toLowerCase();
    const articles = document.querySelectorAll('.news-article-item');
    
    articles.forEach(article => {
        const title = article.querySelector('.news-article-title').textContent.toLowerCase();
        if (title.includes(searchTerm)) {
            article.style.display = 'block';
        } else {
            article.style.display = 'none';
        }
    });
}
